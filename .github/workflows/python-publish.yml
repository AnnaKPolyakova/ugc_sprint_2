name: Python application

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  checks:
    strategy:
      matrix:
        python-version: [ '3.7', '3.8', '3.9' ]

    runs-on: ubuntu-latest
    services:
      mongors1n1:
        image: mongo
        options: --name mongors1n1 --restart always --shardsvr --replSet mongors1 --dbpath /data/db --port 27017
        ports:
          - 27017:27017
        volumes:
          - /etc/localtime:/etc/localtime:ro
          - /tmp/mongo_cluster/data1:/data/db
      mongors1n2:
        image: mongo
        options: --name mongors1n2 --restart always --shardsvr --replSet mongors1 --dbpath /data/db --port 27017
        ports:
          - 27027:27017
        volumes:
          - /etc/localtime:/etc/localtime:ro
          - /tmp/mongo_cluster/data2:/data/db
      mongors2n1:
        image: mongo
        options: --name mongors2n1 --shardsvr --replSet mongors2 --dbpath /data/db --port 27017
        ports:
          - 27047:27017
        volumes:
          - /etc/localtime:/etc/localtime:ro
          - /tmp/mongo_cluster/data4:/data/db
      mongors2n2:
        image: mongo
        options: --name mongors2n2 --restart always --shardsvr --replSet mongors2 --dbpath /data/db --port 27017
        ports:
          - 27057:27017
        volumes:
          - /etc/localtime:/etc/localtime:ro
          - /tmp/mongo_cluster/data5:/data/db
      mongos1:
        image: mongo
        options: --name mongos1 --restart always --configdb mongors1conf/mongocfg1:27017 --port 27017 --bind_ip_all
        ports:
          - 27019:27017
        volumes:
          - /etc/localtime:/etc/localtime:ro
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version:  ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install wemake-python-styleguide flake8-html lxml mypy
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Lint with flake8
      run: |
         flake8 . --format=html --htmldir output

    - name: mypy
      run: |
         mypy .

    - name: Test with pytest
      run: |
        pytest

  send_message:
    runs-on: ubuntu-latest
    needs: checks
    steps:
      - name: send message
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: ${{ github.workflow }} успешно выполнен!
