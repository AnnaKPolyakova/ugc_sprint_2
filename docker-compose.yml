version: '2.2'
services:
    users_actions_app:
      build:
        context: .
#        dockerfile: ./Dockerfile
      ports:
        - "5000:5000"
      volumes:
#        - ./users_actions_app:/code
        - ./logs/users_actions_app:/users_actions_app/logs
#        - ./users_actions_app/logs:/users_actions_app/logs
      #        - static_value:/code/static/
#        - media_value:/code/media/
      command: gunicorn users_actions_app.wsgi_app:app --bind 0.0.0.0:5000  --reload
      networks:
        - moves_network
#      logging:
#        driver: gelf
#        options:
#          gelf-address: udp://127.0.0.1:5044
#          tag: users_actions_app

    nginx:
      image: nginx:1.19.2
      volumes:
        - /tmp/logs/nginx/:/var/log/nginx/
        - ./deploy/etc/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
        - ./deploy/etc/nginx/conf.d:/etc/nginx/conf.d:ro
#      logging:
#        driver: gelf
#        options:
#          gelf-address: udp://127.0.0.1:5044
#          tag: 'nginx'

      depends_on:
        - users_actions_app
      ports:
        - 8080:80
      networks:
        - moves_network

    filebeat:
      image: docker.elastic.co/beats/filebeat:8.7.0-arm64
      volumes:
        - /var/lib/docker/containers:/var/lib/docker/containers:ro
        - /tmp/logs/nginx:/var/log/nginx:ro
        - ./logs/users_actions_app:/users_actions_app/logs
        - ./deploy/filebeat.yml:/usr/share/filebeat/filebeat.yml
      depends_on:
        - users_actions_app
        - nginx
      links:
        - logstash
      networks:
        - moves_network
#      command: ["filebeat", "-e"]

#volumes:
#  static_value:
#  media_value:

networks:
  moves_network:
    name: moves_network
    external: true